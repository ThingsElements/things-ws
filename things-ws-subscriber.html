<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">

<script src="../stomp-websocket/lib/stomp.min.js"></script>
<script src="../sockjs/sockjs.min.js"></script>

<dom-module id="things-ws-subscriber">
  <script>
    Polymer({
      is: 'things-ws-subscriber',

      behaviors: [
        Things.GlobalBehavior
      ],

      properties: {
        /**
         * ws connection subject
         */
        subject: {
          type: String
        },

        /**
         * ws url
         */
        wsUrl: {
          type: String,
          observer: '_wsUrlChanged'
        },

        /**
         * global 변수에서 ws url이 저장 되어 있는 key 값
         */
        urlKey: {
          type: String,
          observer: '_urlKeyChanged'
        },

        /**
         * login property
         */
        login: {
          type: String
        }
      },

      observers: [
        'globalsChanged(globals.*)'
      ],

      /**
       * global 변수의 urlKey와 같은 값이 변화 하면 
       * wsUrl을 초기화
       */
      globalsChanged: function(obj) {
        if(obj.path.indexOf(this.urlKey) >= 0) {
          this.wsUrl = this.globals[this.urlKey];
        }
      },

      /**
       * wsUrl 변경시 ws 연결
       */
      _wsUrlChanged: function() {
        if(this.wsUrl && this.wsUrl != '')
        this.start();
      },

      /**
       * urlKey 변경시 wsUrl 초기화
       */
      _urlKeyChanged: function(urlKey) {
        if(!this.globals && !this.globals[urlKey]) return;
        
        this.wsUrl = this.globals[urlKey];
      },

      /**
       * disconnect from stomp server
       */
      stop: function() {
        /* implementation for stomp */
        if(this.client) {
          this.client.disconnect(function() {
            console.warn('ws disconnected')
          });

          this.client = null
        }
      },

      /**
       * connect to stomp server
       */
      start: function() {
        this.stop()

        var socket = new SockJS(this.wsUrl);
        this.client = Stomp.over(socket);

        var self = this
        // this allows to display debug logs directly on the web page
        this.client.debug = function(str) {
          // console.log(str)
        };

        // the client is notified when it is connected to the server.
        // client.connect(login, passcode, function(frame) {
        this.client.connect({}, function(frame) {
          self.client.subscribe(self.subject, function(message) {
            var message = JSON.parse(message.body);
            self.fire('iron-signal', { name: 'subscribed', data: message });
          })
        })
      },

      /**
       * connection status
       * return true / false
       */
      status: function() {
        return this.client.connected;
      }
    })
  </script>
</dom-module>